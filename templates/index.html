<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Agent Demo - AI Reasoning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .agent-thinking {
            animation: pulse 2s infinite;
        }
        .agent-reasoning {
            animation: typewriter 0.5s steps(40, end);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes typewriter {
            from { width: 0; }
            to { width: 100%; }
        }
        .reasoning-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .success-bubble {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .error-bubble {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        .agent-avatar {
            transition: all 0.3s ease;
        }
        .agent-avatar.thinking {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        .agent-avatar.validating {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        .agent-avatar.deciding {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
        }
        .agent-avatar.exception {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div x-data="qaAgentDemo()" x-init="init()">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-700 text-white py-6">
            <div class="container mx-auto px-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">
                            <i class="fas fa-robot mr-3"></i>QA Agent Reasoning Demo
                        </h1>
                        <p class="text-lg opacity-90">Watch AI agents reason through trade validation</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold" x-text="processingTime || 'Ready'"></div>
                        <div class="text-sm opacity-75">Processing Time</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container mx-auto px-6 py-6">
            <!-- Control Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-xl font-bold mb-4 text-gray-800">
                    <i class="fas fa-cogs mr-2"></i>Demo Controls
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Scenario</label>
                        <select x-model="selectedScenario" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="success">✅ Success Scenario (TKT67890)</option>
                            <option value="failure">❌ Failure Scenario (TKT67891)</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button @click="startReasoning()" 
                                :disabled="isRunning"
                                class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                            <i class="fas fa-play mr-2" x-show="!isRunning"></i>
                            <i class="fas fa-spinner fa-spin mr-2" x-show="isRunning"></i>
                            <span x-text="isRunning ? 'AI is thinking...' : 'Start AI Reasoning'"></span>
                        </button>
                    </div>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button @click="resetDemo()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-refresh mr-2"></i>Reset
                    </button>
                </div>
            </div>

            <!-- Main Agent Interface -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-start space-x-4">
                    <!-- Agent Avatar -->
                    <div class="flex-shrink-0">
                        <div class="agent-avatar w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white"
                             :class="{
                                 'bg-blue-500': currentAgent === 'orchestrator',
                                 'bg-green-500': currentAgent === 'validator',
                                 'bg-purple-500': currentAgent === 'decision',
                                 'bg-red-500': currentAgent === 'exception',
                                 'bg-gray-500': currentAgent === 'idle',
                                 'thinking': isThinking,
                                 'validating': currentAgent === 'validator' && isThinking,
                                 'deciding': currentAgent === 'decision' && isThinking,
                                 'exception': currentAgent === 'exception' && isThinking
                             }">
                            <i x-show="currentAgent === 'orchestrator'" class="fas fa-brain"></i>
                            <i x-show="currentAgent === 'validator'" class="fas fa-check-circle"></i>
                            <i x-show="currentAgent === 'decision'" class="fas fa-gavel"></i>
                            <i x-show="currentAgent === 'exception'" class="fas fa-exclamation-triangle"></i>
                            <i x-show="currentAgent === 'idle'" class="fas fa-robot"></i>
                        </div>
                    </div>

                    <!-- Agent Reasoning -->
                    <div class="flex-1">
                        <div class="reasoning-bubble text-white p-4 rounded-lg mb-4">
                            <div class="flex items-center mb-2">
                                <span class="font-bold text-lg" x-text="agentName"></span>
                                <span x-show="isThinking" class="ml-2 text-sm opacity-75">is thinking...</span>
                            </div>
                            <div class="text-sm opacity-90" x-text="currentReasoning"></div>
                        </div>

                        <!-- Progress Steps -->
                        <div class="space-y-2">
                            <template x-for="(step, index) in reasoningSteps" :key="index">
                                <div class="flex items-center space-x-2 text-sm"
                                     :class="{
                                         'text-gray-500': step.status === 'pending',
                                         'text-blue-600': step.status === 'active',
                                         'text-green-600': step.status === 'completed',
                                         'text-red-600': step.status === 'failed'
                                     }">
                                    <i x-show="step.status === 'pending'" class="fas fa-circle text-gray-300"></i>
                                    <i x-show="step.status === 'active'" class="fas fa-circle text-blue-500"></i>
                                    <i x-show="step.status === 'completed'" class="fas fa-check-circle text-green-500"></i>
                                    <i x-show="step.status === 'failed'" class="fas fa-times-circle text-red-500"></i>
                                    <span x-text="step.text"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Tabs -->
            <div x-show="finalResult" class="bg-white rounded-lg shadow-lg">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button @click="activeTab = 'outcome'" 
                                :class="activeTab === 'outcome' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-chart-line mr-2"></i>Final Outcome
                        </button>
                        <button @click="activeTab = 'reasoning'" 
                                :class="activeTab === 'reasoning' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-brain mr-2"></i>AI Reasoning
                        </button>
                        <button @click="activeTab = 'audit'" 
                                :class="activeTab === 'audit' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-search mr-2"></i>Audit Trace
                        </button>
                        <button @click="activeTab = 'architecture'" 
                                :class="activeTab === 'architecture' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                                class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-sitemap mr-2"></i>Architecture
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Final Outcome Tab -->
                    <div x-show="activeTab === 'outcome'">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4" 
                                 :class="finalResult.decision === 'PASS' ? 'text-green-500' : 'text-red-500'">
                                <i x-show="finalResult.decision === 'PASS'" class="fas fa-check-circle"></i>
                                <i x-show="finalResult.decision === 'FAIL'" class="fas fa-times-circle"></i>
                            </div>
                            <h2 class="text-3xl font-bold mb-2"
                                :class="finalResult.decision === 'PASS' ? 'text-green-600' : 'text-red-600'"
                                x-text="finalResult.decision"></h2>
                            <p class="text-lg text-gray-600" x-text="finalResult.summary"></p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600" x-text="finalResult.checks_passed"></div>
                                <div class="text-sm text-gray-600">Checks Passed</div>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-lg">
                                <div class="text-2xl font-bold text-green-600" x-text="finalResult.processing_time"></div>
                                <div class="text-sm text-gray-600">Processing Time</div>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-lg">
                                <div class="text-2xl font-bold text-purple-600">$0.50</div>
                                <div class="text-sm text-gray-600">Cost per Trade</div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Reasoning Tab -->
                    <div x-show="activeTab === 'reasoning'">
                        <h3 class="text-xl font-bold mb-4">AI Agent Reasoning Process</h3>
                        <div class="space-y-4">
                            <template x-for="(step, index) in reasoningSteps" :key="index">
                                <div class="border-l-4 pl-4 py-2"
                                     :class="{
                                         'border-blue-400 bg-blue-50': step.status === 'completed',
                                         'border-red-400 bg-red-50': step.status === 'failed',
                                         'border-gray-300 bg-gray-50': step.status === 'pending'
                                     }">
                                    <div class="font-medium" x-text="step.text"></div>
                                    <div x-show="step.details" class="text-sm text-gray-600 mt-1" x-text="step.details"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Audit Trace Tab -->
                    <div x-show="activeTab === 'audit'">
                        <h3 class="text-xl font-bold mb-4">Complete Audit Trail</h3>
                        <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto">
                            <div x-text="auditTrace"></div>
                        </div>
                    </div>

                    <!-- Architecture Tab -->
                    <div x-show="activeTab === 'architecture'">
                        <h3 class="text-xl font-bold mb-6">Platform Architecture</h3>
                        
                        <!-- Architecture Overview -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- System Overview -->
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-lg">
                                <h4 class="text-lg font-bold mb-4 text-blue-800">
                                    <i class="fas fa-cogs mr-2"></i>System Overview
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium">Architecture Pattern:</span>
                                        <span class="text-blue-600">Microservices + Agent-Based</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Deployment:</span>
                                        <span class="text-blue-600">Cloud-Native (K8s)</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Scalability:</span>
                                        <span class="text-blue-600">Horizontal Auto-Scaling</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Availability:</span>
                                        <span class="text-blue-600">99.9% SLA</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Metrics -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-lg">
                                <h4 class="text-lg font-bold mb-4 text-green-800">
                                    <i class="fas fa-tachometer-alt mr-2"></i>Performance Metrics
                                </h4>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span class="font-medium">Throughput:</span>
                                        <span class="text-green-600">10,000+ trades/hour</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Latency:</span>
                                        <span class="text-green-600">&lt; 100ms average</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Accuracy:</span>
                                        <span class="text-green-600">99.99%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="font-medium">Uptime:</span>
                                        <span class="text-green-600">24/7/365</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Architecture Diagram -->
                        <div class="bg-white border-2 border-gray-200 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-bold mb-4 text-gray-800">
                                <i class="fas fa-sitemap mr-2"></i>System Architecture
                            </h4>
                            
                            <!-- Frontend Layer -->
                            <div class="mb-4">
                                <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-desktop text-blue-600 mr-2"></i>
                                            <span class="font-medium text-blue-800">Presentation Layer</span>
                                        </div>
                                        <span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">React/Vue.js</span>
                                    </div>
                                    <div class="text-sm text-blue-700 mt-1">Web UI, Mobile App, API Gateway</div>
                                </div>
                            </div>

                            <!-- API Gateway -->
                            <div class="flex justify-center mb-4">
                                <div class="bg-gray-200 px-4 py-1 rounded-full text-sm">
                                    <i class="fas fa-arrow-down text-gray-600"></i>
                                </div>
                            </div>

                            <!-- Agent Layer -->
                            <div class="mb-4">
                                <div class="bg-purple-100 border border-purple-300 rounded-lg p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <i class="fas fa-robot text-purple-600 mr-2"></i>
                                            <span class="font-medium text-purple-800">AI Agent Layer</span>
                                        </div>
                                        <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded">Python/Flask</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <div class="bg-white p-2 rounded border">
                                            <i class="fas fa-brain text-blue-500 mr-1"></i>
                                            <span class="text-gray-700">Orchestrator</span>
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                            <span class="text-gray-700">Validator</span>
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <i class="fas fa-gavel text-purple-500 mr-1"></i>
                                            <span class="text-gray-700">Decision</span>
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>
                                            <span class="text-gray-700">Exception</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Layer -->
                            <div class="flex justify-center mb-4">
                                <div class="bg-gray-200 px-4 py-1 rounded-full text-sm">
                                    <i class="fas fa-arrow-down text-gray-600"></i>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- External APIs -->
                                <div class="bg-orange-100 border border-orange-300 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-cloud text-orange-600 mr-2"></i>
                                        <span class="font-medium text-orange-800 text-sm">External APIs</span>
                                    </div>
                                    <div class="text-xs text-orange-700 space-y-1">
                                        <div>• WorkHub API</div>
                                        <div>• FeeApp API</div>
                                        <div>• Email Service</div>
                                    </div>
                                </div>

                                <!-- Database -->
                                <div class="bg-green-100 border border-green-300 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-database text-green-600 mr-2"></i>
                                        <span class="font-medium text-green-800 text-sm">Database</span>
                                    </div>
                                    <div class="text-xs text-green-700 space-y-1">
                                        <div>• PostgreSQL</div>
                                        <div>• Redis Cache</div>
                                        <div>• Audit Logs</div>
                                    </div>
                                </div>

                                <!-- Message Queue -->
                                <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                                    <div class="flex items-center mb-2">
                                        <i class="fas fa-stream text-yellow-600 mr-2"></i>
                                        <span class="font-medium text-yellow-800 text-sm">Message Queue</span>
                                    </div>
                                    <div class="text-xs text-yellow-700 space-y-1">
                                        <div>• Apache Kafka</div>
                                        <div>• Event Streaming</div>
                                        <div>• Notifications</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technology Stack -->
                        <div class="bg-gray-50 rounded-lg p-6 mb-6">
                            <h4 class="text-lg font-bold mb-4 text-gray-800">
                                <i class="fas fa-code mr-2"></i>Technology Stack
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="bg-white p-4 rounded-lg border">
                                    <div class="font-medium text-gray-800 mb-2">Backend</div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div>• Python 3.13</div>
                                        <div>• Flask/FastAPI</div>
                                        <div>• LangChain</div>
                                        <div>• OpenAI API</div>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border">
                                    <div class="font-medium text-gray-800 mb-2">Frontend</div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div>• React/Vue.js</div>
                                        <div>• Tailwind CSS</div>
                                        <div>• Alpine.js</div>
                                        <div>• WebSocket</div>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border">
                                    <div class="font-medium text-gray-800 mb-2">Infrastructure</div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div>• Docker</div>
                                        <div>• Kubernetes</div>
                                        <div>• AWS/Azure</div>
                                        <div>• Terraform</div>
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg border">
                                    <div class="font-medium text-gray-800 mb-2">Monitoring</div>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <div>• Prometheus</div>
                                        <div>• Grafana</div>
                                        <div>• ELK Stack</div>
                                        <div>• Jaeger</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security & Compliance -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h4 class="text-lg font-bold mb-4 text-red-800">
                                <i class="fas fa-shield-alt mr-2"></i>Security & Compliance
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <div class="font-medium text-red-800 mb-2">Security Features</div>
                                    <div class="text-sm text-red-700 space-y-1">
                                        <div>• End-to-end encryption</div>
                                        <div>• OAuth 2.0 / JWT</div>
                                        <div>• Role-based access control</div>
                                        <div>• API rate limiting</div>
                                        <div>• Input validation & sanitization</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-medium text-red-800 mb-2">Compliance</div>
                                    <div class="text-sm text-red-700 space-y-1">
                                        <div>• SOC 2 Type II</div>
                                        <div>• GDPR compliant</div>
                                        <div>• PCI DSS ready</div>
                                        <div>• Audit trail logging</div>
                                        <div>• Data retention policies</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function qaAgentDemo() {
            return {
                selectedScenario: 'success',
                isRunning: false,
                isThinking: false,
                currentAgent: 'idle',
                currentReasoning: 'Ready to analyze trade validation...',
                processingTime: 'Ready',
                finalResult: null,
                activeTab: 'outcome',
                reasoningSteps: [],
                auditTrace: '',

                init() {
                    this.loadWorkflowStatus();
                },

                get agentName() {
                    const names = {
                        'orchestrator': 'Orchestrator Agent',
                        'validator': 'Validation Agent',
                        'decision': 'Decision Agent',
                        'exception': 'Exception Agent',
                        'idle': 'QA Agent'
                    };
                    return names[this.currentAgent] || 'QA Agent';
                },

                async startReasoning() {
                    this.isRunning = true;
                    this.isThinking = true;
                    this.finalResult = null;
                    this.reasoningSteps = [];
                    this.auditTrace = '';
                    this.activeTab = 'outcome';

                    const ticketId = this.selectedScenario === 'success' ? 'TKT67890' : 'TKT67891';
                    const scenario = this.selectedScenario === 'success' ? 'happy' : 'fail';

                    try {
                        const response = await fetch('/api/start_workflow', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                ticket_id: ticketId,
                                scenario: scenario
                            })
                        });

                        if (response.ok) {
                            this.simulateReasoningProcess();
                        }
                    } catch (error) {
                        console.error('Error starting workflow:', error);
                        this.isRunning = false;
                        this.isThinking = false;
                    }
                },

                simulateReasoningProcess() {
                    const startTime = Date.now();
                    
                    // Step 1: Orchestrator
                    this.currentAgent = 'orchestrator';
                    this.currentReasoning = 'Analyzing trade ticket and determining validation requirements...';
                    this.addReasoningStep('Analyzing trade ticket', 'active');
                    
                    setTimeout(() => {
                        this.addReasoningStep('Trade type: SP, Platform: Madrid', 'completed');
                        this.addReasoningStep('Account identified: ' + (this.selectedScenario === 'success' ? 'ACC12345' : 'ACC67891'), 'completed');
                        
                        // Step 2: Data Collection
                        this.currentAgent = 'validator';
                        this.currentReasoning = 'Fetching trade data from multiple sources...';
                        this.addReasoningStep('Fetching WorkHub fee modification data', 'active');
                        
                        setTimeout(() => {
                            this.addReasoningStep('WorkHub data retrieved: new_rate=0.65', 'completed');
                            this.addReasoningStep('Fetching FeeApp approval information', 'active');
                            
                            setTimeout(() => {
                                const approvedRate = this.selectedScenario === 'success' ? '0.65' : '0.60';
                                this.addReasoningStep(`FeeApp data retrieved: approved_rate=${approvedRate}`, 'completed');
                                this.addReasoningStep('Checking email approval status', 'active');
                                
                                setTimeout(() => {
                                    this.addReasoningStep('Email approval confirmed', 'completed');
                                    
                                    // Step 3: Validation
                                    this.currentReasoning = 'Running business rule validations...';
                                    this.addReasoningStep('Validating rate match (rounded to 2 decimal places)', 'active');
                                    
                                    setTimeout(() => {
                                        const rateMatch = this.selectedScenario === 'success';
                                        if (rateMatch) {
                                            this.addReasoningStep('Rate match validation: PASSED (0.65 == 0.65)', 'completed');
                                        } else {
                                            this.addReasoningStep('Rate match validation: FAILED (0.65 != 0.60)', 'failed');
                                        }
                                        
                                        this.addReasoningStep('Validating approval email exists', 'active');
                                        setTimeout(() => {
                                            this.addReasoningStep('Approval email validation: PASSED', 'completed');
                                            this.addReasoningStep('Validating effective date window (7-day rule)', 'active');
                                            
                                            setTimeout(() => {
                                                this.addReasoningStep('Date window validation: PASSED', 'completed');
                                                
                                                // Step 4: Decision
                                                this.currentAgent = 'decision';
                                                this.currentReasoning = 'Aggregating results and making final decision...';
                                                this.addReasoningStep('Aggregating validation results', 'active');
                                                
                                                setTimeout(() => {
                                                    const passedChecks = rateMatch ? 3 : 2;
                                                    this.addReasoningStep(`Checks passed: ${passedChecks}/3`, 'completed');
                                                    
                                                    const decision = rateMatch ? 'PASS' : 'FAIL';
                                                    this.addReasoningStep(`Final decision: ${decision}`, 'completed');
                                                    
                                                    // Step 5: Exception handling if needed
                                                    if (!rateMatch) {
                                                        this.currentAgent = 'exception';
                                                        this.currentReasoning = 'Generating exception email for escalation...';
                                                        this.addReasoningStep('Exception email generated', 'completed');
                                                    }
                                                    
                                                    // Finalize
                                                    this.isThinking = false;
                                                    this.isRunning = false;
                                                    this.currentAgent = 'idle';
                                                    this.currentReasoning = 'Analysis complete. Trade validation finished.';
                                                    
                                                    const endTime = Date.now();
                                                    this.processingTime = `${(endTime - startTime)}ms`;
                                                    
                                                    this.finalResult = {
                                                        decision: decision,
                                                        summary: decision === 'PASS' ? 'All validations passed. Trade approved.' : 'Validation failed. Trade rejected due to rate mismatch.',
                                                        checks_passed: passedChecks,
                                                        processing_time: this.processingTime
                                                    };
                                                    
                                                    this.generateAuditTrace();
                                                    
                                                }, 1000);
                                            }, 800);
                                        }, 600);
                                    }, 1000);
                                }, 400);
                            }, 600);
                        }, 800);
                    }, 1000);
                },

                addReasoningStep(text, status, details = null) {
                    this.reasoningSteps.push({
                        text: text,
                        status: status,
                        details: details,
                        timestamp: new Date().toISOString()
                    });
                },

                generateAuditTrace() {
                    this.auditTrace = `QA Agent Audit Trail
=====================================
Timestamp: ${new Date().toISOString()}
Ticket ID: ${this.selectedScenario === 'success' ? 'TKT67890' : 'TKT67891'}
Scenario: ${this.selectedScenario}
Account: ${this.selectedScenario === 'success' ? 'ACC12345' : 'ACC67891'}

AGENT EXECUTION LOG:
===================

1. ORCHESTRATOR AGENT
   - Status: COMPLETED
   - Action: Analyzed trade ticket
   - Result: Trade type SP, Platform Madrid identified
   - Timestamp: ${new Date().toISOString()}

2. DATA REQUEST AGENT
   - Status: COMPLETED
   - Action: Fetched WorkHub fee modification data
   - Result: new_rate=0.65, modified_timestamp=2025-10-02T10:15:00
   - Timestamp: ${new Date().toISOString()}

3. DATA REQUEST AGENT
   - Status: COMPLETED
   - Action: Fetched FeeApp approval data
   - Result: approved_rate=${this.selectedScenario === 'success' ? '0.65' : '0.60'}
   - Timestamp: ${new Date().toISOString()}

4. VALIDATION AGENT
   - Status: COMPLETED
   - Action: Rate match validation
   - Result: ${this.selectedScenario === 'success' ? 'PASSED (0.65 == 0.65)' : 'FAILED (0.65 != 0.60)'}
   - Timestamp: ${new Date().toISOString()}

5. VALIDATION AGENT
   - Status: COMPLETED
   - Action: Approval email validation
   - Result: PASSED (email exists)
   - Timestamp: ${new Date().toISOString()}

6. VALIDATION AGENT
   - Status: COMPLETED
   - Action: Date window validation
   - Result: PASSED (within 7-day window)
   - Timestamp: ${new Date().toISOString()}

7. DECISION AGENT
   - Status: COMPLETED
   - Action: Final decision
   - Result: ${this.finalResult.decision}
   - Reasoning: ${this.finalResult.summary}
   - Timestamp: ${new Date().toISOString()}

${this.finalResult.decision === 'FAIL' ? `
8. EXCEPTION AGENT
   - Status: COMPLETED
   - Action: Exception email generation
   - Result: Email sent to controls-qa-exceptions@firm.com
   - Timestamp: ${new Date().toISOString()}
` : ''}

FINAL RESULT:
=============
Decision: ${this.finalResult.decision}
Processing Time: ${this.processingTime}
Checks Passed: ${this.finalResult.checks_passed}/3
Business Impact: ${this.finalResult.decision === 'PASS' ? 'Trade approved for execution' : 'Trade blocked - risk prevented'}

AUDIT COMPLETE
===============`;
                },

                async loadWorkflowStatus() {
                    try {
                        const response = await fetch('/api/workflow_status');
                        const data = await response.json();
                        // Handle any additional status loading if needed
                    } catch (error) {
                        console.error('Error loading workflow status:', error);
                    }
                },

                resetDemo() {
                    this.isRunning = false;
                    this.isThinking = false;
                    this.currentAgent = 'idle';
                    this.currentReasoning = 'Ready to analyze trade validation...';
                    this.processingTime = 'Ready';
                    this.finalResult = null;
                    this.reasoningSteps = [];
                    this.auditTrace = '';
                    this.activeTab = 'outcome';
                }
            }
        }
    </script>
</body>
</html>